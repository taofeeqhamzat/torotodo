<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Toro - Task Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'bg': 'var(--color-bg)',
            'card': 'var(--color-card)',
            'text': 'var(--color-text)',
            'muted': 'var(--color-muted)',
            'accent': 'var(--color-accent)',
            'accent-hover': 'var(--color-accent-hover)',
            'danger': 'var(--color-danger)',
            'danger-hover': 'var(--color-danger-hover)',
            'border': 'var(--color-border)',
            'border-light': 'var(--color-border-light)',
          }
        }
      }
    }
  </script>
  <style>
    :root {
      --color-bg: #0f172a;
      --color-card: #111827;
      --color-text: #f1f5f9;
      --color-muted: #94a3b8;
      --color-accent: #3b82f6;
      --color-accent-hover: #2563eb;
      --color-danger: #ef4444;
      --color-danger-hover: #dc2626;
      --color-border: #1e293b;
      --color-border-light: #334155;
    }

    .light {
      --color-bg: #f8fafc;
      --color-card: #ffffff;
      --color-text: #0f172a;
      --color-muted: #64748b;
      /* accent and danger colors can remain the same or be adjusted */
      --color-border: #e2e8f0;
      --color-border-light: #f1f5f9;
    }

    body {
      font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Ubuntu, Cantarell, sans-serif;
      background-color: var(--color-bg);
      min-height: 100vh;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .animate-fade-in {
      animation: fadeIn 0.6s ease-out;
    }

  </style>
</head>

<body>
  <div class="max-w-2xl mx-auto my-16 px-5 md:my-16 my-5 md:px-5 px-4">
    <div class="bg-card border border-border rounded-2xl p-8 md:p-8 p-6 shadow-2xl backdrop-blur-sm animate-fade-in" role="application" aria-label="Todo app">
      <header class="mb-8 flex justify-between items-center">
        <div>
          <h1 class="text-3xl font-bold bg-gradient-to-r from-text to-muted bg-clip-text text-transparent">Toro</h1>
          <div class="text-muted text-base leading-relaxed mt-1">Your personal task manager</div>
        </div>
        <button id="theme-toggle" class="w-10 h-10 rounded-full flex items-center justify-center bg-transparent text-muted border border-border-light cursor-pointer transition-all duration-200 hover:bg-accent/10 hover:text-accent hover:border-accent text-xl"></button>
      </header>

      <section class="mb-6">
        <div class="flex gap-3 items-center md:flex-row flex-col">
          <input id="newTodo" type="text" placeholder="What needs to be done?" aria-label="New todo" 
                 class="flex-1 px-4 py-3.5 rounded-xl border border-border-light bg-slate-900/80 text-text text-base transition-all duration-200 focus:outline-none focus:border-accent focus:ring-3 focus:ring-accent/10 placeholder:text-muted w-full" />
          <input id="newTodoDueDate" type="date" aria-label="Due date"
                 class="px-4 py-3.5 rounded-xl border border-border-light bg-slate-900/80 text-muted text-base transition-all duration-200 focus:outline-none focus:border-accent focus:ring-3 focus:ring-accent/10 w-full md:w-auto" />
          <button id="addBtn" aria-label="Add todo" 
                  class="px-5 py-3.5 rounded-xl bg-accent text-white font-semibold text-sm cursor-pointer transition-all duration-200 hover:bg-accent-hover hover:-translate-y-0.5 whitespace-nowrap md:w-auto w-full">Add Task</button>
        </div>
      </section>

      <section class="mb-4">
        <input id="search" type="text" placeholder="Search..." aria-label="Search todos"
               class="w-full px-4 py-3.5 rounded-xl border border-border-light bg-slate-900/80 text-text text-base transition-all duration-200 focus:outline-none focus:border-accent focus:ring-3 focus:ring-accent/10 placeholder:text-muted" />
      </section>

      <section class="mb-5 flex md:flex-row flex-col md:items-center md:justify-between gap-4">
        <div class="flex gap-2 flex-wrap" role="tablist" aria-label="Filters">
          <span class="pill active px-4 py-2 rounded-full border border-accent text-accent bg-accent/15 cursor-pointer text-sm font-medium transition-all duration-200" data-filter="all" role="tab" aria-selected="true">All</span>
          <span class="pill px-4 py-2 rounded-full border border-border-light cursor-pointer text-muted text-sm font-medium transition-all duration-200 hover:bg-accent/10 hover:border-accent hover:text-accent" data-filter="active" role="tab" aria-selected="false">Active</span>
          <span class="pill px-4 py-2 rounded-full border border-border-light cursor-pointer text-muted text-sm font-medium transition-all duration-200 hover:bg-accent/10 hover:border-accent hover:text-accent" data-filter="completed" role="tab" aria-selected="false">Completed</span>
          <span class="pill px-4 py-2 rounded-full border border-border-light cursor-pointer text-muted text-sm font-medium transition-all duration-200 hover:bg-accent/10 hover:border-accent hover:text-accent" data-filter="overdue" role="tab" aria-selected="false">Overdue</span>
          <span class="pill px-4 py-2 rounded-full border border-border-light cursor-pointer text-muted text-sm font-medium transition-all duration-200 hover:bg-accent/10 hover:border-accent hover:text-accent" data-action="clearCompleted" title="Remove all completed">Clear Completed</span>
        </div>
        <div class="flex gap-2 flex-wrap items-center text-sm">
          <label for="sort-by" class="text-muted font-medium">Sort by:</label>
          <select id="sort-by" class="bg-slate-900/80 border border-border-light rounded-lg px-3 py-1.5 text-sm text-muted focus:outline-none focus:border-accent focus:ring-2 focus:ring-accent/20">
            <option value="createdAt">Created</option>
            <option value="dueAt">Due Date</option>
            <option value="completed">Completed</option>
          </select>
        </div>
      </section>

      <section class="min-h-[100px]">
        <ul id="list" aria-live="polite" class="list-none m-0 p-0 mt-6"></ul>
      </section>

      <footer class="flex justify-between items-center mt-6 pt-5 border-t border-border text-muted text-sm md:flex-row flex-col gap-3 text-center">
        <div class="font-medium">
          <span id="count">0</span> tasks • <span id="storage"></span>
        </div>
        <div class="text-xs opacity-80">
          <span class="kbd px-2 py-1 border border-border-light rounded text-xs text-muted bg-slate-900/50">Enter</span> to add •
        </div>
      </footer>

      <section class="mt-6 pt-5 border-t border-border">
        <div class="flex gap-2 flex-wrap">
          <button class="ghost px-4 py-2 rounded-xl bg-transparent text-muted border border-border-light cursor-pointer transition-all duration-200 hover:bg-accent/10 hover:text-accent hover:border-accent" id="exportBtn" title="Export as JSON">Export JSON</button>
          <button class="ghost px-4 py-2 rounded-xl bg-transparent text-muted border border-border-light cursor-pointer transition-all duration-200 hover:bg-accent/10 hover:text-accent hover:border-accent" id="exportCsvBtn" title="Export as CSV">Export CSV</button>
          <button class="ghost px-4 py-2 rounded-xl bg-transparent text-muted border border-border-light cursor-pointer transition-all duration-200 hover:bg-accent/10 hover:text-accent hover:border-accent" id="importBtn" title="Import from JSON">Import</button>
          <input type="file" id="fileInput" accept="application/json" hidden />
        </div>
      </section>
    </div>
  </div>

  <script>
    $(document).ready(function() {
      // --- Storage & State ------------------------------------------------------
      const LS_KEY = "todos.v1";
      const state = {
        filter: "all",
        sortBy: localStorage.getItem("todos.sortBy") || "createdAt",
        todos: load(),
        searchQuery: ""
      };

      // --- Utility Functions ---------------------------------------------------
      function debounce(func, delay) {
        let timeout;
        return function(...args) {
          const context = this;
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(context, args), delay);
        };
      }

      function uid() {
        return Math.random().toString(36).slice(2) + Date.now().toString(36);
      }

      function load() {
        try {
          const raw = localStorage.getItem(LS_KEY);
          return raw ? JSON.parse(raw) : [];
        } catch { 
          return []; 
        }
      }

      function save() {
        localStorage.setItem(LS_KEY, JSON.stringify(state.todos));
        updateStorageInfo();
      }

      function updateStorageInfo() {
        const bytes = new Blob([localStorage.getItem(LS_KEY) || ""]).size;
        const kb = (bytes / 1024).toFixed(1);
        $("#storage").text(`${kb} KB used`);
      }

      // --- CRUD Operations -----------------------------------------------------
      function addTodo(title, dueAt) {
        title = (title || "").trim();
        if (!title) return;
        
        state.todos.push({ 
          id: uid(), 
          title, 
          completed: false, 
          createdAt: Date.now(),
          dueAt: dueAt ? new Date(dueAt).toISOString() : null
        });
        save();
        render();
      }

      function toggleTodo(id) {
        const todo = state.todos.find(t => t.id === id);
        if (todo) {
          todo.completed = !todo.completed;
          save();
          render();
        }
      }

      function deleteTodo(id) {
        state.todos = state.todos.filter(t => t.id !== id);
        save();
        render();
      }

      function updateTodo(id, title) {
        const todo = state.todos.find(t => t.id === id);
        if (todo) {
          todo.title = title.trim();
          save();
          render();
        }
      }

      function clearCompleted() {
        state.todos = state.todos.filter(t => !t.completed);
        save();
        render();
      }

      // --- Rendering -----------------------------------------------------------
      function getFiltered() {
        let todos = [...state.todos];

        // Filter by status
        switch (state.filter) {
          case "active":
            todos = todos.filter(t => !t.completed);
            break;
          case "completed":
            todos = todos.filter(t => t.completed);
            break;
          case "overdue":
            const today = new Date().setHours(0, 0, 0, 0);
            todos = todos.filter(t => {
              if (!t.dueAt || t.completed) return false;
              return new Date(t.dueAt).setHours(0, 0, 0, 0) < today;
            });
            break;
        }

        // Filter by search query
        if (state.searchQuery) {
          const query = state.searchQuery.toLowerCase();
          todos = todos.filter(t => t.title.toLowerCase().includes(query));
        }

        return sortTodos(todos);
      }

      function sortTodos(todos) {
        switch (state.sortBy) {
          case 'dueAt':
            return todos.sort((a, b) => {
              if (a.dueAt && b.dueAt) return new Date(a.dueAt) - new Date(b.dueAt);
              return a.dueAt ? -1 : 1;
            });
          case 'completed':
            return todos.sort((a, b) => a.completed - b.completed);
          case 'createdAt':
          default:
            return todos.sort((a, b) => b.createdAt - a.createdAt);
        }
      }

      function formatDueDate(dueAt) {
        if (!dueAt) return '';

        const date = new Date(dueAt);
        const now = new Date();
        const isToday = date.toDateString() === now.toDateString();
        const isTomorrow = new Date(now.setDate(now.getDate() + 1)).toDateString() === date.toDateString();

        let formattedDate;
        if (isToday) {
          formattedDate = 'Today';
        } else if (isTomorrow) {
          formattedDate = 'Tomorrow';
        } else {
          formattedDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        const isPast = new Date(dueAt).setHours(0,0,0,0) < new Date().setHours(0,0,0,0);
        const colorClass = isPast ? 'text-danger' : 'text-muted';

        return `<div class="text-xs ${colorClass} mt-1">${formattedDate}</div>`;
      }

      function createTodoItem(todo) {
        const $li = $(`
          <li class="flex items-start gap-3 py-4 border-b border-border transition-all duration-200 hover:bg-accent/5 hover:rounded-lg hover:mx-[-8px] hover:px-2 ${todo.completed ? 'opacity-75' : ''}" data-id="${todo.id}">
            <input type="checkbox" class="w-5 h-5 accent-accent cursor-pointer mt-1" ${todo.completed ? 'checked' : ''}>
            <label class="flex-1">
              <span class="text-base leading-relaxed ${todo.completed ? 'text-muted line-through' : 'text-text'}">${todo.title}</span>
              ${formatDueDate(todo.dueAt)}
            </label>
            <button class="w-6 h-6 md:w-6 md:h-6 w-7 h-7 rounded-full bg-transparent text-muted border border-transparent flex items-center justify-center text-base md:text-base text-lg opacity-60 md:opacity-60 opacity-50 transition-all duration-200 hover:bg-danger/10 hover:text-danger hover:border-danger hover:opacity-100 hover:scale-110 md:hover:scale-110 hover:scale-115" title="Delete task">×</button>
          </li>
        `);

        // Event handlers
        $li.find('input[type="checkbox"]').on('change', () => toggleTodo(todo.id));
        $li.find('button').on('click', () => deleteTodo(todo.id));
        // Inline editing
        $li.find('label').on('click', (e) => e.preventDefault())
        .on('dblclick', function() {
          if ($(this).find('input').length > 0) return;

          const $span = $(this).find('span:first');
          const $input = $(`<input class="flex-1 px-3 py-2 rounded-lg border border-accent bg-slate-900/90 text-text text-base" value="${todo.title}">`);
          
          $span.replaceWith($input);
          $input.focus().select();
          
          const commit = () => {
            const val = $input.val().trim();
            if (val) {
              updateTodo(todo.id, val);
            } else {
              deleteTodo(todo.id);
            }
          };
          
          const cancel = () => render();

          $input.on('keydown', function(e) {
            if (e.key === 'Enter') commit();
            if (e.key === 'Escape') cancel();
          }).on('blur', cancel);
        });

        return $li;
      }

      function render() {
        const $list = $("#list");
        $list.empty();
        
        getFiltered().forEach(todo => {
          $list.append(createTodoItem(todo));
        });
        
        $("#count").text(state.todos.length);
        
        // Update filter pills
        $(".pill[role='tab']").each(function() {
          const $pill = $(this);
          const isActive = $pill.data('filter') === state.filter;
          
          $pill.removeClass('active')
               .attr('aria-selected', isActive);
               
          if (isActive) {
            $pill.addClass('active px-4 py-2 rounded-full border border-accent text-accent bg-accent/15 cursor-pointer text-sm font-medium transition-all duration-200');
          } else {
            $pill.addClass('px-4 py-2 rounded-full border border-border-light cursor-pointer text-muted text-sm font-medium transition-all duration-200 hover:bg-accent/10 hover:border-accent hover:text-accent');
          }
        });

        // Update sort dropdown
        $("#sort-by").val(state.sortBy);
      }

      // --- Import/Export --------------------------------------------------------
      function exportJSON() {
        const blob = new Blob([JSON.stringify(state.todos, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const $a = $('<a>').attr({ href: url, download: "todos.json" });
        $('body').append($a);
        $a[0].click();
        $a.remove();
        URL.revokeObjectURL(url);
      }

      function exportCSV() {
        const headers = ["id", "title", "completed", "createdAt", "dueAt"];

        const escapeCsvField = (field) => {
          const str = String(field === null || field === undefined ? '' : field);
          if (str.includes(',') || str.includes('"') || str.includes('\\n')) {
            return `"${str.replace(/"/g, '""')}"`;
          }
          return str;
        };

        const csvRows = state.todos.map(todo => {
          const row = [
            todo.id,
            todo.title,
            todo.completed,
            todo.createdAt,
            todo.dueAt || ''
          ];
          return row.map(escapeCsvField).join(',');
        });

        const csvString = [headers.join(','), ...csvRows].join('\n');
        const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const $a = $('<a>').attr({ href: url, download: 'todos.csv' });
        $('body').append($a);
        $a[0].click();
        $a.remove();
        URL.revokeObjectURL(url);
      }

      function importJSON(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const arr = JSON.parse(e.target.result);
            if (!Array.isArray(arr)) throw new Error("Invalid JSON format");
            
            // Normalize imported data
            state.todos = arr.map(t => ({
              id: t.id || uid(),
              title: String(t.title || "").trim(),
              completed: !!t.completed,
              createdAt: Number(t.createdAt || Date.now()),
              dueAt: t.dueAt ? new Date(t.dueAt).toISOString() : null
            })).filter(t => t.title);
            
            save();
            render();
          } catch (err) {
            alert("Import failed: " + err.message);
          }
        };
        reader.readAsText(file);
      }

      // --- Event Handlers ------------------------------------------------------
      $("#search").on('input', debounce(function() {
        state.searchQuery = $(this).val();
        render();
      }, 250));

      $("#addBtn").on('click', function() {
        const title = $("#newTodo").val();
        const dueAt = $("#newTodoDueDate").val();
        addTodo(title, dueAt);
        $("#newTodo").val('').focus();
        $("#newTodoDueDate").val('');
      });

      $("#newTodo").on('keydown', function(e) {
        if (e.key === 'Enter') {
          const title = $(this).val();
          const dueAt = $("#newTodoDueDate").val();
          addTodo(title, dueAt);
          $(this).val('');
          $("#newTodoDueDate").val('');
        }
      });

      $(".pill").on('click', function() {
        const $pill = $(this);
        const filter = $pill.data('filter');
        const action = $pill.data('action');
        
        if (filter) {
          state.filter = filter;
          render();
        } else if (action === 'clearCompleted') {
          clearCompleted();
        }
      });

      $("#sort-by").on('change', function() {
        const sortBy = $(this).val();
        state.sortBy = sortBy;
        localStorage.setItem("todos.sortBy", sortBy);
        render();
      });

      $("#exportBtn").on('click', exportJSON);
      $("#exportCsvBtn").on('click', exportCSV);
      
      $("#importBtn").on('click', function() {
        $("#fileInput").click();
      });
      
      $("#fileInput").on('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          importJSON(file);
          $(this).val(''); // Reset file input
        }
      });

      // --- Theme Switcher -----------------------------------------------------
      const THEME_KEY = "theme";
      const $html = $("html");
      const $toggle = $("#theme-toggle");

      function applyTheme(theme) {
        if (theme === "light") {
          $html.addClass("light");
          $toggle.text("🌙");
        } else {
          $html.removeClass("light");
          $toggle.text("☀️");
        }
        localStorage.setItem(THEME_KEY, theme);
      }

      $toggle.on("click", () => {
        const currentTheme = $html.hasClass("light") ? "light" : "dark";
        applyTheme(currentTheme === "light" ? "dark" : "light");
      });

      // Load initial theme
      const savedTheme = localStorage.getItem(THEME_KEY) || "dark";
      applyTheme(savedTheme);

      // --- Bootstrap ------------------------------------------------------------
      // Only seed initial data for first-time users (when localStorage has never been initialized)
      const hasBeenInitialized = localStorage.getItem(LS_KEY) !== null;
      if (state.todos.length === 0 && !hasBeenInitialized) {
        // Seed initial data for workshop
        state.todos = [
          { 
            id: uid(), 
            title: "Explore the app", 
            completed: true, 
            createdAt: Date.now() - 86400000 
          },
          { 
            id: uid(), 
            title: "Post a Tweet about #GoogleCloudRoadshow", 
            completed: false, 
            createdAt: Date.now() 
          },          
          { 
            id: uid(), 
            title: "Call Uncle Bob", 
            completed: false, 
            createdAt: Date.now() 
          }
        ];
        save();
      }
      
      updateStorageInfo();
      render();
    });
  </script>
</body>

</html>